{% extends "layout.html" %}

{% block title %}Add Recipe{% endblock %}
{% block content %}
<style>
  /* Ingredient Rows */
.ingredient-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}

.ingredient-type {
    min-width: 150px;
    flex: 1;
}

.ingredient-name {
    flex: 2;
}

.ingredient-measurement {
    flex: 2;
    display: flex;
    gap: 5px;
}

.ingredient-measurement input {
    flex: 1;
}

.remove-ingredient {
    background-color: #ff6b6b;
    color: white;
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

.remove-ingredient:hover {
    background-color: #ff3d3d;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .ingredient-row {
        flex-direction: column;
        gap: 8px;
    }
    
    .ingredient-type,
    .ingredient-name,
    .ingredient-measurement {
        width: 100%;
    }
}
</style>
<div class="add-recipe-container">
  <form method="POST" action="{{ url_for('recipe_views.add_recipe_action') }}" enctype="multipart/form-data" id="recipeForm">
    <input type="hidden" name="user_id" value="{{ current_user.id }}">
    
    <div class="header-row">
      <h1>Add Recipe:</h1>
      <button type="submit" class="submit-btn rectangle">ADD RECIPE</button>
    </div>

    <div class="form-container">
      <!-- Recipe Name -->
      <div class="form-row">
        <div class="input-group name-field">
          <div class="input-label">Recipe Name:</div>
          <div class="input-field rectangle">
            <input type="text" name="title" class="hidden-input" placeholder="Recipe name" required>
          </div>
        </div>
      </div>

      <!-- Description and Cook Time -->
      <div class="form-row">
        <div class="input-group">
          <div class="input-label">Description:</div>
          <div class="input-field rectangle">
            <input type="text" name="description" class="hidden-input" placeholder="Short description">
          </div>
        </div>
        <div class="input-group">
          <div class="input-label">Cook Time:</div>
          <div class="input-field rectangle">
            <input type="text" name="cook_time" class="hidden-input" placeholder="e.g., 30 mins">
          </div>
        </div>
      </div>

      <!-- Image URL -->
      <div class="form-row">
        <div class="input-group">
          <div class="input-label">Image URL:</div>
          <div class="input-field rectangle">
            <input type="url" name="image_url" class="hidden-input" placeholder="https://example.com/image.jpg">
          </div>
        </div>
      </div>

      <!-- Ingredients Section -->
      <div class="ingredients-section rectangle">
        <div class="section-title">Ingredients:</div>
        <div class="ingredient-controls" id="ingredientsContainer">
          <!-- Template for one ingredient row -->
          <div class="ingredient-row">
            <div class="ingredient-type rectangle">
              <select name="ingredient_category_0" class="hidden-select" required>
                <option value="">Select Category</option>
                <option value="produce">Produce</option>
                <option value="dairy">Dairy</option>
                <option value="spices">Herbs/Spices</option>
                <option value="meat">Meat</option>
                <option value="pantry">Pantry</option>
              </select>
            </div>
            <div class="ingredient-name rectangle">
              <input type="text" name="ingredient_name_0" class="hidden-input" placeholder="Ingredient" required>
            </div>
            <div class="ingredient-measurement rectangle">
              <input type="text" name="ingredient_quantity_0" class="hidden-input" placeholder="Quantity" required>
              <select name="ingredient_unit_0" class="hidden-select">
                <option value="unit">unit</option>
                <option value="cup">cup</option>
                <option value="teaspoon">teaspoon</option>
                <option value="Tablespoon">Tablespoon</option>
                <option value="pound">pound</option>
              </select>
            </div>
            <button type="button" class="remove-ingredient">-</button>
          </div>
        </div>
        <button type="button" id="addIngredient" class="ellipse-btn">
          <img src="{{ url_for('static', filename='images/plus-icon.png') }}" width="21" height="23" alt="Add ingredient">
        </button>
      </div>

      <!-- Directions Section -->
      <div class="directions-section rectangle">
        <div class="section-title">Directions:</div>
        <textarea name="instructions" class="hidden-textarea" placeholder="Enter each step on a new line" required></textarea>
      </div>
    </div>
  </form>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
      console.log('[START] Form handler initialization');
  
      // 1. Get form elements with paranoid-level checking
      const form = document.getElementById('recipeForm');
      if (!form) {
          console.error('CRITICAL ERROR: Form element not found!');
          alert('System error: Cannot find form. Please reload the page.');
          return;
      }
  
      console.log('[OK] Form element found:', form);
  
      // 2. Set up ingredient management
      let ingredientCounter = document.querySelectorAll('.ingredient-row').length;
      console.log(`[INGREDIENTS] Found ${ingredientCounter} existing ingredients`);
  
      // 3. Add ingredient with bulletproof cloning
      function addIngredient() {
          console.log('[ACTION] Attempting to add ingredient');
          
          try {
              const template = document.querySelector('.ingredient-row');
              if (!template) throw new Error('Template not found');
              
              const newRow = template.cloneNode(true);
              const newIndex = ingredientCounter++;
              
              // Update ALL attributes that might need new indexes
              newRow.querySelectorAll('[name], [id], [for]').forEach(el => {
                  if (el.name) el.name = el.name.replace(/\d+$/, newIndex);
                  if (el.id) el.id = el.id.replace(/\d+$/, newIndex);
                  if (el.htmlFor) el.htmlFor = el.htmlFor.replace(/\d+$/, newIndex);
              });
              
              // Clear all values in the new row
              newRow.querySelectorAll('input, select, textarea').forEach(el => {
                  if (el.type !== 'submit') {
                      el.value = '';
                      el.checked = false;
                      el.selectedIndex = 0;
                  }
              });
              
              // Remove validation attributes
              newRow.querySelectorAll('[required], [pattern], [min], [max]').forEach(el => {
                  el.removeAttribute('required');
                  el.removeAttribute('pattern');
                  el.removeAttribute('min');
                  el.removeAttribute('max');
              });
              
              document.getElementById('ingredientsContainer').appendChild(newRow);
              console.log(`[SUCCESS] Added ingredient row ${newIndex}`);
          } catch (error) {
              console.error('[ERROR] Failed to add ingredient:', error);
              alert('Failed to add ingredient. Please try again.');
          }
      }
  
      // 4. Nuclear-grade form validation
      function validateForm() {
          console.log('[VALIDATION] Starting validation');
          let isValid = true;
          
          // Validate title
          const titleInput = form.querySelector('[name="title"]');
          if (!titleInput?.value?.trim()) {
              console.warn('[VALIDATION] Title is required');
              titleInput?.focus();
              alert('Recipe title is required');
              return false;
          }
  
          // Validate ingredients
          const ingredientRows = Array.from(document.querySelectorAll('.ingredient-row'));
          let validIngredients = 0;
          
          for (const [index, row] of ingredientRows.entries()) {
              const nameInput = row.querySelector('[name^="ingredient_name_"]');
              const name = nameInput?.value?.trim();
              
              if (name) {
                  const categorySelect = row.querySelector('[name^="ingredient_category_"]');
                  const quantityInput = row.querySelector('[name^="ingredient_quantity_"]');
                  
                  if (!categorySelect?.value) {
                      console.warn(`[VALIDATION] Row ${index}: Category required for "${name}"`);
                      categorySelect?.focus();
                      alert(`Please select a category for "${name}"`);
                      return false;
                  }
                  
                  if (!quantityInput?.value?.trim()) {
                      console.warn(`[VALIDATION] Row ${index}: Quantity required for "${name}"`);
                      quantityInput?.focus();
                      alert(`Please enter quantity for "${name}"`);
                      return false;
                  }
                  
                  validIngredients++;
              }
          }
          
          if (validIngredients === 0) {
              console.warn('[VALIDATION] At least one ingredient required');
              document.querySelector('[name^="ingredient_name_"]')?.focus();
              alert('At least one complete ingredient is required');
              return false;
          }
          
          console.log('[VALIDATION] Form is valid');
          return true;
      }
  
      // 5. Form submission with military-grade error handling
      async function handleSubmit(e) {
          console.log('[SUBMIT] Form submission started');
          e.preventDefault();
          
          // Disable submit button to prevent double-submission
          const submitBtn = form.querySelector('button[type="submit"]');
          submitBtn.disabled = true;
          submitBtn.textContent = 'Submitting...';
          
          try {
              if (!validateForm()) {
                  console.log('[SUBMIT] Validation failed - aborting');
                  return;
              }
              
              // Prepare form data
              const formData = new FormData(form);
              console.log('[DATA] Form contents:', Object.fromEntries(formData.entries()));
              
              // Send request
              console.log('[NETWORK] Sending to:', form.action);
              const response = await fetch(form.action, {
                  method: 'POST',
                  body: formData,
                  headers: {
                      'Accept': 'application/json',
                      'X-Requested-With': 'XMLHttpRequest'
                  }
              });
              
              console.log('[NETWORK] Response status:', response.status);
              
              // Handle response
              if (response.redirected) {
                  console.log('[REDIRECT] Redirecting to:', response.url);
                  window.location.href = response.url;
                  return;
              }
              
              const contentType = response.headers.get('content-type');
              if (contentType?.includes('application/json')) {
                  const data = await response.json();
                  console.log('[RESPONSE] JSON data:', data);
                  if (data.error) {
                      alert(data.error);
                  } else if (data.success) {
                      window.location.href = data.redirect || '/';
                  }
              } else {
                  const text = await response.text();
                  console.warn('[RESPONSE] Non-JSON response:', text);
                  alert('Server response was not in expected format');
              }
          } catch (error) {
              console.error('[ERROR] Submission failed:', error);
              alert('Submission failed. Please check your connection and try again.');
          } finally {
              submitBtn.disabled = false;
              submitBtn.textContent = 'ADD RECIPE';
              console.log('[SUBMIT] Submission process completed');
          }
      }
  
      // 6. Event listeners with fallback
      function setupEventListeners() {
          // Add ingredient button
          const addBtn = document.getElementById('addIngredient');
          if (addBtn) {
              addBtn.addEventListener('click', addIngredient);
              console.log('[EVENTS] Added ingredient button listener');
          } else {
              console.warn('[WARNING] Add ingredient button not found');
          }
          
          // Form submission
          form.addEventListener('submit', handleSubmit);
          console.log('[EVENTS] Added form submit listener');
          
          // Remove ingredients
          const container = document.getElementById('ingredientsContainer');
          if (container) {
              container.addEventListener('click', function(e) {
                  if (e.target.classList.contains('remove-ingredient')) {
                      e.preventDefault();
                      const rows = document.querySelectorAll('.ingredient-row');
                      if (rows.length > 1) {
                          e.target.closest('.ingredient-row').remove();
                          console.log('[ACTION] Removed ingredient row');
                      }
                  }
              });
          }
      }
  
      // Initialize everything
      setupEventListeners();
      console.log('[READY] Form handler is fully operational');
  });
  </script>
{% endblock %}